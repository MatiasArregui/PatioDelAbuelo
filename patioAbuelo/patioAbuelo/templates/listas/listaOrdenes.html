{% extends "base.html" %}
{% block estilos %}
<style>
/* Contenedor con tamaño fijo */
.cont {
  position: relative; 
  height: 120px; 
  border-radius: 10px; 
  overflow: hidden;
  color: white;
  display: flex; 
  align-items: center; 
  justify-content: center;
}
  
/* Imagen de fondo con desenfoque */
.cont::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url("../../../media/estilos_h1/ordenes.jpg"); 
  background-size: cover;
  background-position: center;
  filter: blur(4px);
  z-index: -1; 
  opacity: 0.8; 
}
  
/* Estilo para el título */
.titulo {
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6); 
}
/* barra de busqueda*/
.search-bar {
  margin: 20px;
}
  
.search-input {
  border-top-left-radius: 20px;
  border-bottom-left-radius: 20px;
  border-right: none;
  padding: 10px 15px;
}
.search-btn {
  border-top-right-radius: 20px;
  border-bottom-right-radius: 20px;
  background-color: #007bff;
  border: none;
  padding: 10px 15px;
}
.search-btn:hover {
  background-color: #0056b3;
}
.search-btn svg {
  vertical-align: middle;
}
.input-group .form-control:focus {
  box-shadow: none;
  border-color: #007bff;
}

.input-group {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  border-radius: 20px;
}
.btn-limpiar {
    border-top-right-radius: 20px;
  border-bottom-right-radius: 20px;
  background-color: #ff3b2e;
  border: none;
  padding: 10px 15px;
  color: white;
}
.btn-limpiar:hover {
    background-color: #ff6f61;
    color:white;
    
}
.btn-limpiar:focus {
    box-shadow: 0 0 0 0.2rem rgba(255, 111, 97, 0.5);
}

/*estilos divs*/
.contenedor-orden {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6; 
  border-radius: 0.25rem; 
  padding: 1rem; 
  margin-bottom: 1rem; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  transition: transform 0.2s ease-in-out; 
}
      
.contenedor-orden:hover {
  transform: scale(1.02); 
}
  
.contenedor-orden h1 {
  font-size: 1.5rem; 
  color: #343a40; 
  margin-bottom: 0.5rem; 
}
  
.contenedor-orden p {
  font-size: 1rem; 
  color: #6c757d; 
  margin-bottom: 0.5rem; 
}
  
.contenedor-orden button {
  font-size: 0.875rem; 
  padding: 0.5rem 1rem; 
  border: none; 
  border-radius: 0.25rem; 
  transition: background-color 0.2s ease-in-out; 
}
  
.contenedor-orden button a {
  color: white; 
}
    
.contenedor-orden button.btn-primary {
  background-color: #007bff; 
}
    
.contenedor-orden button.btn-primary:hover {
  background-color: #0056b3; 
}
      
.contenedor-orden button.btn-danger {
  background-color: #dc3545; 
}
  
.contenedor-orden button.btn-danger:hover {
  background-color: #c82333; 
}

/* Estilos de la ventana modal */
.modal-titulo {
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 1rem;
  text-align: center;
}

.modal-descripcion, .modal-precio {
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
}

.modal-imagen {
  display: block;
  margin: 0 auto;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.botones-modal {
  display: flex;
  justify-content: space-around;
  margin-top: 20px;
}
.botones-modal a {
  width: 45%;
  text-align: center;
  padding: 10px;
  border: none;
  border-radius: 5px;
  text-decoration: none;
  color: white;
}
.btn-modificar {
  background-color: #007bff;
}
.btn-modificar:hover {
  background-color: #0056b3; 
  color:white;
  transform: translateY(-2px); 
}
.btn-eliminar {
  background-color: #dc3545;
}
.btn-eliminar:hover {
  background-color: #c82333; 
  color:white;
  transform: translateY(-2px); 
}

        
.btn-imprimir {
  display: none;
  background-color:rgb(2, 255, 108);
}
/* Mostrar el botón de imprimir solo en dispositivos de escritorio */
@media (min-width: 1024px) {
  .btn-imprimir {
      display: inline-block;
  }
}
.btn-imprimir:hover {
  background-color: rgb(6, 179, 78); 
  color:white;
  transform: translateY(-2px); 
}
.modal-header {
  background-color: #f8f9fa; 
  border-bottom: 1px solid #dee2e6; 
  display: flex;
  justify-content: space-between; 
  align-items: center; 
  padding: 15px; 
  border-top-left-radius: 10px; 
  border-top-right-radius: 10px; 
}
  
.modal-title {
  font-size: 1.75rem;
  font-weight: bold;
  color: #343a40; 
  margin: 0; 
}
      
.close {
  padding: 5px 10px;
  border: none;
  background: transparent;
  font-size: 1.5rem;
  color: #343a40;
  opacity: 0.8;
  transition: color 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
  cursor: pointer;
}
      
.close:hover {
  color: #ff0000; 
  background-color: rgba(255, 0, 0, 0.1); 
  transform: scale(1.1); 
  opacity: 1;
}

.close span {
  display: inline-block;
  font-weight: bold;
}
.light-red-bg {
  background-color: #ffcccc; 
}
      
      
</style>


{% endblock %}

{% block content %}
  <div class="container mb-5">
      <h1 class="text-center mt-1 cont titulo">Lista Ordenes</h1>
      <form method="GET" class="search-bar col-10 col-md-6 col-lg-4">
        <div class="input-group">
          <select name="filtro" class="form-control">
            <option value="todas" {% if filtro == "todas" %}selected{% endif %}>Todas</option>
            <option value="entregadas" {% if filtro == "entregadas" %}selected{% endif %}>Entregadas</option>
            <option value="no_entregadas" {% if filtro == "no_entregadas" %}selected{% endif %}>En preparación</option>
          </select>
          <button class="btn btn-primary search-btn" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-search" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
            </svg>
          </button>
          <button class="btn btn-limpiar" type="reset" onclick="clearSearch()">
            Limpiar
          </button>
        </div>
      </form>
      
      {% for o in ordenes %}
        {% if o.id not in facturaOrden %}
        {% comment %} Aqui establecemos el div completo como boton de accion para que actue la ventana modal {% endcomment %}
          <div class="contenedor-orden">
            <h1 data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}">{{o.id_mesa.nombre | title}}</h1>
            <p data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}"><strong>Mozo: {{o.id_mozo.nombre | title}}</strong></p>
            <pdata-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}">{{o.fecha}}</pdata-toggle=>
            {% if o.entregado %}
              <p data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
                data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
                data-url-eliminar="{% url 'ordenBorrar' o.id %}">Entregada</p>
            {% endif %}
            <p data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}">{{o.observacion}}</p>
            <hr>
            <h6 data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}">Platos</h6>
            {% for carta in cartaOrden %}
              {% if carta.id_orden.pk == o.id %}
                <p data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
                  data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
                  data-url-eliminar="{% url 'ordenBorrar' o.id %}">{{carta.id_carta.nombre}} {{carta.cantidad}}</p>
              {% endif %}
            {% endfor %}
            <p data-toggle="modal" data-target="#orderModal" data-id="{{ o.id }}" data-mesa="{{ o.id_mesa.nombre }}" data-fecha="{{ o.fecha }}" data-observacion="{{ o.observacion }}" data-total="{{ o.total }}" 
              data-platos="[{% for carta in cartaOrden %}{% if carta.id_orden.pk == o.id %}'{{ carta.id_carta.nombre }} {{ carta.cantidad }}',{% endif %}{% endfor %}]" data-url-modificar="{% url 'ordenModificar' o.id %}" 
              data-url-eliminar="{% url 'ordenBorrar' o.id %}"><b>Total: {{o.total}}</b></p>
            {% if perms.miAplicacion.change_orden %}
              <div class="d-flex justify-content-end gap-1">
                <button class="btn btn-sm btn-primary"><a href="/ordenes/ordenModif/{{ o.id }}" class="text-white text-decoration-none">Modificar</a></button>
                <button class="btn btn-sm btn-danger"><a href="/ordenes/ordenBorrar/{{ o.id }}" class="text-white text-decoration-none">Eliminar</a></button>
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}


    {% comment %} Ventana modal que se activa al tocar el contenedor (div) de la orden {% endcomment %}
    <div id="orderModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="printable-area-header">
            <h5 class="modal-title" id="orderModalLabel">Detalles de la Orden</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="printable-area-body">
            <p class="modal-descripcion"><strong>Mesa:</strong> <span id="orden-mesa"></span></p>
            <p class="modal-descripcion"><strong>Fecha:</strong> <span id="orden-fecha"></span></p>
            <p class="modal-descripcion"><strong>Observación:</strong> <span id="orden-observacion"></span></p>
            <h6><strong>Platos</strong></h6>
            <div id="orden-platos"></div>
            <p class="modal-descripcion"><strong>Total:</strong> <span id="orden-total"></span></p>
          </div>
          <div class="modal-footer botones-modal">
            {% if perms.miAplicacion.add_orden %}
              <a id="orden-modificar-btn" href="#" class="btn btn-modificar m-1">Modificar</a>
              <a id="orden-eliminar-btn" href="#" class="btn btn-eliminar m-1">Eliminar</a>
            {% endif %}
            <a class="btn btn-imprimir m-1" href="#" onclick="printOrderDetails()">Imprimir</a>
          </div>
        </div>
      </div>
    </div>


      {% comment %} Boton que permite agregar nueva orden {% endcomment %}
      {% if perms.miAplicacion.add_orden %}
        <a href={% url "ordenNueva" %} class="customButton">+</a>
      {% endif %}
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    //Esta funcion limpia la busqueda. Busca por "name" el filtro y le da el nuevo valor "todas"
    function clearSearch() {
      document.querySelector('[name="filtro"]').value = 'todas';  
      window.location.href = window.location.pathname;  
    }
    
    
    $('#orderModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget); 
      var mesa = button.data('mesa');
      var fecha = button.data('fecha');
      var observacion = button.data('observacion');
      var total = button.data('total');
      var platos = button.data('platos');
      var urlModificar = button.data('url-modificar');
      var urlEliminar = button.data('url-eliminar');
    
      // Estos le dan un valor a los campos del modal, que se obtienen en la parte de arriba
      var modal = $(this);
      modal.find('#orden-mesa').text(mesa);
      modal.find('#orden-fecha').text(fecha);
      modal.find('#orden-observacion').text(observacion);
      modal.find('#orden-total').text(total);
    
      // Obtener los platos correspondientes a la orden
      const platosContainer = modal.find('#orden-platos');
      platosContainer.empty();
    
      // Limpiar y formatear los datos de los platos
      var platosArray = platos.replace(/[\[\]']/g, "").split(',');
    
      // Agregar cada plato al contenedor
      platosArray.forEach(plato => {
        let platoElement = document.createElement('p');
        platoElement.textContent = plato.trim();
        platosContainer.append(platoElement);
      });
    
      // Actualiza los enlaces de los botones en el modal
      modal.find('#orden-modificar-btn').attr('href', urlModificar);
      modal.find('#orden-eliminar-btn').attr('href', urlEliminar);
    });
    // Esta funcion establece que parte del DOM se imprimira
    function printOrderDetails() {
      const printableHeader = document.getElementById('printable-area-header').outerHTML;
      const printableBody = document.getElementById('printable-area-body').outerHTML;
      const printContent = printableHeader + printableBody;
      const originalContent = document.body.innerHTML;
    
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload();
    }
    </script>
    

  {% endblock %}